@copilot Profile the performance of the code affected by this PR. Add microbenchmarks to measure critical functions and document the before/after results in the PR description. Optimize without changing public behavior: reduce algorithmic complexity, avoid unnecessary allocations, batch operations, and ensure thread safety. Add tests simulating concurrent access to reveal and fix race conditions.